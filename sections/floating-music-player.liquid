<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tracks = [
      {
        title: "Track 1",
        url: "{{ section.settings.track_1_url }}"
      },
      {
        title: "Track 2",
        url: "{{ section.settings.track_2_url }}"
      },
      {
        title: "Track 3",
        url: "{{ section.settings.track_3_url }}"
      }
    ].filter(track => track.url);

    const cdIcon = document.getElementById("cd-icon");
    const audio = document.getElementById("audio-player");
    const title = document.getElementById("track-title");
    const toggleButton = document.getElementById("music-toggle-button");
    const nextButton = document.getElementById("next-track");
    const playIcon = document.getElementById("icon-play");
    const pauseIcon = document.getElementById("icon-pause");

    if (!tracks.length) {
      console.warn("No audio tracks configured.");
      title.textContent = "No tracks loaded.";
      return;
    }

    let currentTrack = 0;
    let isPlaying = false;
    const wasPaused = localStorage.getItem('yossi_music_paused') === 'true';

    function updateIcons() {
      if (isPlaying) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        cdIcon.classList.add('spin');
      } else {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        cdIcon.classList.remove('spin');
      }
    }

    function loadTrack(index) {
      if (!tracks[index]) return;
      audio.src = tracks[index].url;
      title.textContent = tracks[index].title || "Untitled Track";
    }

    function playMusic() {
      audio.play().then(() => {
        isPlaying = true;
        updateIcons();
        localStorage.setItem('yossi_music_paused', 'false');
      }).catch((err) => {
        console.warn("Autoplay blocked:", err);
      });
    }

    function pauseMusic() {
      audio.pause();
      isPlaying = false;
      updateIcons();
      localStorage.setItem('yossi_music_paused', 'true');
    }

    function toggleMusic() {
      if (audio.paused) {
        playMusic();
      } else {
        pauseMusic();
      }
    }

    function nextTrack() {
      currentTrack = (currentTrack + 1) % tracks.length;
      loadTrack(currentTrack);
      if (!audio.paused) {
        playMusic();
      }
    }

    toggleButton.addEventListener("pointerdown", toggleMusic);
    cdIcon.addEventListener("pointerdown", toggleMusic);
    nextButton.addEventListener("click", nextTrack);
    audio.addEventListener("ended", nextTrack);

    loadTrack(currentTrack);

    function triggerPlayOnce() {
      if (!isPlaying && !wasPaused) {
        playMusic();
      }
      window.removeEventListener('scroll', triggerPlayOnce);
      window.removeEventListener('click', triggerPlayOnce);
      window.removeEventListener('touchstart', triggerPlayOnce);
    }

    if (!wasPaused) {
      // Wait for user gesture before playing
      window.addEventListener('scroll', triggerPlayOnce);
      window.addEventListener('click', triggerPlayOnce);
      window.addEventListener('touchstart', triggerPlayOnce);
    } else {
      pauseMusic();
    }
  });
</script>
