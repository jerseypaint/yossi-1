{% if template.name != 'index' %}
<div id="floating-music-player">
  <div id="track-title">Loading...</div>

  <div class="cd-wrapper">
    <img id="cd-icon" src="{{ section.settings.cd_image | image_url: width: 200 }}" alt="Music Disc" />
    <button id="music-toggle-button" aria-label="Toggle music">
      <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="black">
        <path d="M8 5v14l11-7z" />
      </svg>
      <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" class="icon hidden" viewBox="0 0 24 24" fill="black">
        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
      </svg>
    </button>
  </div>

  <audio id="audio-player" preload="auto"></audio>
</div>

<style>
  #floating-music-player {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: {{ section.settings.cd_size | default: 60 }}px;
    height: {{ section.settings.cd_size | default: 60 }}px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
  }

  #track-title {
    font-size: 11px;
    color: black;
    margin-bottom: 6px;
    max-width: 120px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .cd-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  #cd-icon {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  #cd-icon.spin {
    animation: spin 4s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #music-toggle-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.7);
    border: none;
    border-radius: 50%;
    padding: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
  }

  #music-toggle-button .icon {
    width: 16px;
    height: 16px;
  }

  .hidden {
    display: none;
  }
</style>

<script>
(function () {
  const audio = document.getElementById("audio-player");
  const cdIcon = document.getElementById("cd-icon");
  const playIcon = document.getElementById("icon-play");
  const pauseIcon = document.getElementById("icon-pause");
  const toggleButton = document.getElementById("music-toggle-button");

  if (!audio || !cdIcon || !playIcon || !pauseIcon || !toggleButton) return;

  const tracks = [
    {
      title: "Track 1",
      url: "{{ section.settings.track_1_url }}"
    },
    {
      title: "Track 2",
      url: "{{ section.settings.track_2_url }}"
    },
    {
      title: "Track 3",
      url: "{{ section.settings.track_3_url }}"
    }
  ].filter(track => track.url);

  let currentTrack = 0;
  let hasInteracted = false;
  const wasPaused = localStorage.getItem('yossi_music_paused') === 'true';
  const lastTime = parseFloat(localStorage.getItem('yossi_music_time') || "0");

  if (!tracks.length) return;

  function loadTrack(index) {
    if (!tracks[index]) return;
    audio.src = tracks[index].url;
    audio.currentTime = lastTime || 0;
    document.getElementById("track-title").textContent = tracks[index].title || "Untitled Track";
  }

  function updateIcons(isPlaying) {
    if (isPlaying) {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      cdIcon.classList.add('spin');
    } else {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      cdIcon.classList.remove('spin');
    }
  }

  function playMusic() {
    audio.play().then(() => {
      updateIcons(true);
      localStorage.setItem('yossi_music_paused', 'false');
    }).catch((err) => console.warn("Autoplay blocked:", err));
  }

  function pauseMusic() {
    audio.pause();
    updateIcons(false);
    localStorage.setItem('yossi_music_paused', 'true');
  }

  function toggleMusic() {
    if (audio.paused) {
      currentTrack = (currentTrack + 1) % tracks.length;
      loadTrack(currentTrack);
      playMusic();
    } else {
      pauseMusic();
    }
  }

  toggleButton.addEventListener("pointerdown", toggleMusic);
  cdIcon.addEventListener("pointerdown", toggleMusic);

  audio.addEventListener("timeupdate", () => {
    localStorage.setItem('yossi_music_time', audio.currentTime);
  });

  audio.addEventListener("ended", () => {
    currentTrack = (currentTrack + 1) % tracks.length;
    loadTrack(currentTrack);
    playMusic();
  });

  function tryAutoPlay() {
    if (!hasInteracted && !wasPaused) {
      hasInteracted = true;
      playMusic();
      document.removeEventListener('scroll', tryAutoPlay);
      document.removeEventListener('click', tryAutoPlay);
      document.removeEventListener('touchstart', tryAutoPlay);
    }
  }

  document.addEventListener('scroll', tryAutoPlay);
  document.addEventListener('click', tryAutoPlay);
  document.addEventListener('touchstart', tryAutoPlay);

  loadTrack(currentTrack);
  updateIcons(!wasPaused);
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Floating Music Player",
  "tag": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "cd_image",
      "label": "CD Icon Image"
    },
    {
      "type": "range",
      "id": "cd_size",
      "label": "CD Size (px)",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 60
    },
    {
      "type": "url",
      "id": "track_1_url",
      "label": "Track 1 URL"
    },
    {
      "type": "url",
      "id": "track_2_url",
      "label": "Track 2 URL"
    },
    {
      "type": "url",
      "id": "track_3_url",
      "label": "Track 3 URL"
    }
  ],
  "presets": [
    {
      "name": "Floating Music Player"
    }
  ]
}
{% endschema %}
